---
title: P4002 生成树计数
tags: solutions
category: 题解
date: 2022-01-17 20:23:11
---

## P4002 生成树计数

~~黑，真$^{\text{TM}}$的黑啊（指题目的颜色）~~

<!-- more -->

### 题面

[题目链接](https://www.luogu.com.cn/problem/P4002)

### 前置知识：求数列幂和

给定序列${a_n}$，对于$0\le t \le k$，求$\sum\limits_{i=1}^n a_i^t$。

先写出幂次和所求值之间的生成函数：

$$
\begin{aligned}
F(x) =& \sum_{t=0}{\sum_{i=1}^{n}{a_i^t x^t}} \\
=& \sum_{i=1}^{n}{\frac{1}{1-a_ix}}
\end{aligned}
$$

不妨设$G(x)=\sum\limits_{i=1}^{n}(\ln'(1-a_ix))$，则有

$$
\begin{aligned}
G(x) =& \sum_{i=1}^n(\ln'(1-a_ix)) \\
=& -\sum_{i=1}^n\frac{a_i}{1-a_ix}
\end{aligned}
$$

于是求出$G(x)$后可以很容易地求出$F(x)$。思考如何求$G(x)$：

$$
\begin{aligned}
G(x) =& \sum_{i=1}^n(\ln'(1-a_ix)) \\
=& \left(\sum_{i=1}^n\ln(1-a_ix)\right)' \\
=& \left(\ln(\prod_{i=1}^n(1-a_ix))\right)'
\end{aligned}
$$

使用分治FFT求出$\prod\limits_{i=1}^n(1-a_ix)$，再$\ln$和求导，求出$G(x)$和$F(x)$，时间复杂度$O(n \log^2 n)$。

### 多项式$\ln \mid \exp$

见{% post_link 'sol-p4725' %}和{% post_link 'sol-p4726' %}。

### 解法

首先，你需要想到使用[prufer序列](https://oi-wiki.org/graph/prufer/)来进行树形态的枚举并计算贡献。

根据prufer序列的定义，一棵$n$个节点的树共有$n^{n-2}$种不同的形态。

我们计算答案时需要的是每个节点的度$deg_u$。

为了方便设$d_u=deg_u-1$，$d_u$的实际意义是$u$在prufer序列中的出现次数。

所以枚举$\sum d_i=n-2$，然后prufer序列的$n-2$个数字排列共$(n-2)!$种情况。于是乎

$$
\begin{aligned}
ans =& \sum_T val(T) \\
=& \sum_T \left(\prod_{i=1}^ndeg_i^m\right) \left(\sum_{i=1}^ndeg_i^m\right) \\
=& \sum_{\sum d_i=n-2}(n-2)!\left(\prod_{i=1}^n(d_i+1)^m\right) \left(\sum_{i=1}^n(d_i+1)^m\right) \left(\prod_{i=1}^n\frac{a_i^{d_i+1}}{d_i!}\right) \\
=& (n-2)! \prod_{i=1}^na_i \sum_{\sum d_i=n-2} \left(\prod_{i=1}^n\frac{a_i^{d_i}}{d_i!}(d_i+1)^m\right) \left(\sum_{i=1}^n(d_i+1)^m\right)
\end{aligned}
$$

左边两项定值先不管，右边几项如下：

$$
\sum_{\sum d_i=n-2} \sum_{i=1}^{n}{\frac{a_i^{d_i}}{d_i!}(d_i+1)^{2m} \prod_{j \neq i}{\frac{a_j^{d_j}}{d_j!}(d_j+1)^m}}
$$

构造两个多项式$A(x)$和$B(x)$：

$$
\begin{aligned}
A(x)=\sum_i\frac{(i+1)^{2m}x^i}{i!} \\
B(x)=\sum_i\frac{(i+1)^mx^i}{i!}
\end{aligned}
$$

则有

$$
\begin{aligned}
F(x) =& \sum_{i=1}^{n}{A(a_ix) \prod_{j\neq i}B(a_jx)} \\
=& \sum_{i=1}^{n}{\frac{A(a_ix)}{B(a_ix)} \prod_{j=1}^{n}B(a_jx)} \\
=& \sum_{i=1}^{n}{\frac{A(a_ix)}{B(a_ix)} \exp\left(\sum_{j=1}^{n}\ln(B(a_jx))\right)}
\end{aligned}
$$

~~已经看晕了？不要紧，我也写晕了（bushi~~

### AC代码

```cpp
🐦🐦🐦🐦🐦🐦🐦
```